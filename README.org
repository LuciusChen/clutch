#+TITLE: mysql.el — Pure Elisp MySQL Client
#+AUTHOR: Lucius Chen

* Overview

A pure Emacs Lisp MySQL client that implements the MySQL wire protocol
directly, without depending on the external =mysql= CLI tool.

Inspired by [[https://github.com/cbbrowne/pg.el][pg.el]] which proved that implementing a database wire protocol
in pure Elisp is entirely feasible.

* Features

- Pure Elisp — no external dependencies
- MySQL wire protocol (HandshakeV10 + HandshakeResponse41)
- =mysql_native_password= and =caching_sha2_password= authentication
- =COM_QUERY= (text protocol) for executing SQL
- Prepared statements (=COM_STMT_PREPARE= / =COM_STMT_EXECUTE= / =COM_STMT_CLOSE=) with binary protocol
- TLS/SSL support via Emacs built-in GnuTLS (STARTTLS upgrade)
- Extended type system: DATE, TIME, DATETIME, TIMESTAMP, BIT with structured parsing
- Convenience macros: =with-mysql-connection=, =with-mysql-transaction=
- Utilities: =mysql-ping=, =mysql-escape-identifier=, =mysql-escape-literal=, =mysql-connect/uri=
- Extensible type parsing via =mysql-type-parsers=
- Proper error signaling with structured error types

* Requirements

- Emacs 28.1+
- A MySQL 5.7+ or 8.x server

* Installation

Clone this repository and add it to your =load-path=:

#+begin_src emacs-lisp
(add-to-list 'load-path "~/repos/mysql.el")
(require 'mysql)
#+end_src

* Usage

#+begin_src emacs-lisp
;; Connect
(setq conn (mysql-connect :host "127.0.0.1"
                           :port 3306
                           :user "root"
                           :password "secret"
                           :database "mydb"))

;; Query
(let ((result (mysql-query conn "SELECT * FROM users LIMIT 10")))
  (mysql-result-columns result)  ;; column metadata
  (mysql-result-rows result))    ;; list of rows (list of values)

;; DML
(let ((result (mysql-query conn "INSERT INTO users (name) VALUES ('alice')")))
  (mysql-result-affected-rows result)  ;; => 1
  (mysql-result-last-insert-id result)) ;; => auto-increment id

;; Disconnect
(mysql-disconnect conn)
#+end_src

** TLS Connection

#+begin_src emacs-lisp
(setq conn (mysql-connect :host "127.0.0.1"
                           :port 3306
                           :user "root"
                           :password "secret"
                           :database "mydb"
                           :tls t))
#+end_src

** URI Connection

#+begin_src emacs-lisp
(setq conn (mysql-connect/uri "mysql://root:secret@127.0.0.1:3306/mydb"))
#+end_src

** Convenience Macros

#+begin_src emacs-lisp
;; Auto-close connection
(with-mysql-connection conn (:host "127.0.0.1" :user "root"
                             :password "secret" :database "mydb")
  (mysql-query conn "SELECT 1"))

;; Transaction with auto-rollback on error
(with-mysql-transaction conn
  (mysql-query conn "INSERT INTO users (name) VALUES ('alice')")
  (mysql-query conn "INSERT INTO users (name) VALUES ('bob')"))
#+end_src

** Prepared Statements

#+begin_src emacs-lisp
(let ((stmt (mysql-prepare conn "SELECT * FROM users WHERE id = ?")))
  (let ((result (mysql-execute stmt 42)))
    (mysql-result-rows result))
  (mysql-stmt-close stmt))
#+end_src

** Utilities

#+begin_src emacs-lisp
(mysql-ping conn)                          ;; => t
(mysql-escape-identifier "my`table")       ;; => "`my``table`"
(mysql-escape-literal "it's a \"test\"")   ;; => "'it\\'s a \\\"test\\\"'"
#+end_src

* Testing

** Unit tests (no server needed)

#+begin_src sh
emacs -batch -L . -l ert -l test/mysql-test.el -f ert-run-tests-batch-and-exit
#+end_src

** Integration tests (require a running MySQL)

Start a MySQL instance:

#+begin_src sh
docker run --rm -e MYSQL_ROOT_PASSWORD=test -p 3306:3306 mysql:8
#+end_src

Run tests:

#+begin_src sh
emacs -batch -L . -l ert -l test/mysql-test.el \
  --eval '(setq mysql-test-password "test")' \
  -f ert-run-tests-batch-and-exit
#+end_src

* License

GPL-3.0-or-later. See [[file:LICENSE][LICENSE]].
